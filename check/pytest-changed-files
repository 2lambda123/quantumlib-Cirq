set -e

if [ -z $1 ]; then
    echo -e "\e[31mSpecify what to diff against (e.g. 'origin/master' or 'HEAD~1').\e[0m"
    exit 1
fi

# Run from repo root.
root=$(git rev-parse --show-toplevel)
cd "${root}"

# Get the _test version of changed python files.
changed=$(git diff --name-only "$1" \
    | grep "\.py$" \
    | sed -e "s/\.py$/_test.py/" \
    | sed -e "s/_test_test\.py$/_test.py/" \
    | perl -ne 'chomp(); if (-e $_) {print "$_\n"}' \
    | uniq \
)
num_changed=$(echo -e "${changed}" | wc -w)

echo "Found ${num_changed} differing files with associated tests."
if [ -z "${changed}" ]; then
    exit 0
fi

pytest ${changed}
