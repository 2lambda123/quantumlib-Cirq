#!/usr/bin/env bash

################################################################################
# Verifies that Python files generated from protobuf definitions are up to date.
#
# See dev_tools/build-protos.sh for building all protos.
################################################################################

# Get the working directory to the repo root.
thisdir="$(dirname "${BASH_SOURCE[0]}")" || exit $?
topdir="$(git -C "${thisdir}" rev-parse --show-toplevel)" || exit $?
cd "${topdir}" || exit $?

git_status="$(git status --short)"
if [[ -n "${git_status}" ]]; then
    echo "$0 requires a pristine worktree, but 'git status --short' shows"
    echo
    echo "${git_status}"
    echo
    echo "Please commit or undo these changes to try again."
    exit 2
fi

echo "Removing generated Python files.  If this script does not restore them"
echo "use  git restore "*_pb2.py*"  to get them back."

git rm --quiet "cirq-google/*_pb2.py*"
# restore deleted files in git index
git reset --quiet

echo "Building protos in $PWD"

dev_tools/build-protos.sh

git_status="$(git status --short)"

if [[ -n "${git_status}" ]]; then
    echo -e "\033[31mERROR: dev_tools/build-protos.sh changed generated files!\033[0m"
    echo -e "\033[31mPlease generate and commit these files using dev_tools/build-protos.sh\033[0m"
    echo
    echo "Note in addition to changed files, there may be new files or orphaned old files."
    echo
    echo "Output of 'git status':"
    echo
    git status
    exit 1
fi
